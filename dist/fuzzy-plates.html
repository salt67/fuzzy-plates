<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fuzzy Plate Search</title>
    <link rel="apple-touch-icon" href="./image-EX1McLRR.png">
    <script type="module" crossorigin>(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function r(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=r(t);fetch(t.href,o)}})();const P=[["D","O"],["M","W"],["P","R"],["7","Z"],["0","D"],["5","S"],["V","W"],["2","Z"],["1","I"],["I","T"],["X","Y"],["7","T"],["0","Q"],["1","L"],["4","L"],["E","F"],["8","B"],["D","Q"],["0","O"],["O","Q"],["0","U"]],g=new Map;for(const[e,n]of P){const r=e.toUpperCase(),s=n.toUpperCase();g.has(r)||g.set(r,new Set),g.has(s)||g.set(s,new Set),g.get(r).add(s),g.get(s).add(r)}function L(e,n){return g.has(e)&&g.get(e).has(n)}function I(e){return e.replace(/[-\s]/g,"").toUpperCase()}function O(e,n){const r=I(n);if(!r)return{match:!0,rendered:e,meta:Array(e.length).fill("")};const s=e.toUpperCase().split("");if(r.length===1){const a=r[0],i=Array(e.length).fill("");let c=!1;for(let f=0;f<s.length;f++){const d=s[f];if(!/[A-Z0-9]/.test(d)){i[f]="-";continue}d===a?(i[f]="E",c=!0):L(d,a)&&(i[f]="F",c=!0)}if(!c)return{match:!1,rendered:null,meta:[]};let m="";for(let f=0;f<e.length;f++){const d=e[f],z=i[f];z==="E"?m+=`<span class="exact-match">${d}</span>`:z==="F"?m+=`<span class="fuzzy-match">${d}</span>`:m+=d}return{match:!0,rendered:m,meta:i}}const t=I(e),o=r.split(""),l=[];for(let a=0;a<=t.length-o.length;a++){let i=!0;const c=Array(t.length).fill(null);let m=0,f=0;for(let d=0;d<o.length;d++){const z=t[a+d],v=o[d];if(z===v)c[a+d]="E",m++;else if(L(z,v))c[a+d]="F",f++;else{i=!1;break}}i&&l.push({start:a,marks:c,exact:m,fuzzy:f})}if(!l.length)return{match:!1,rendered:null,meta:[]};l.sort((a,i)=>i.exact!==a.exact?i.exact-a.exact:a.fuzzy!==i.fuzzy?a.fuzzy-i.fuzzy:a.start-i.start);const S=l[0],p=Array(e.length).fill("");let y=0;for(let a=0;a<e.length;a++){const i=s[a];if(!/[A-Z0-9]/.test(i)){p[a]="-";continue}const c=S.marks[y];c&&(p[a]=c),y++}let u="";for(let a=0;a<e.length;a++){const i=e[a],c=p[a];c==="E"?u+=`<span class="exact-match">${i}</span>`:c==="F"?u+=`<span class="fuzzy-match">${i}</span>`:u+=i}return{match:!0,rendered:u,meta:p}}const E="fuzzyPlateData",$=12,M=["color","make","model"];let w=null,h=new Map;function A(e){return e?new Date(e).toLocaleString():""}function x(e){return e.replace(/[^A-Za-z0-9]/g,"").toUpperCase()}function B(e){const n={color:new Set,make:new Set,model:new Set};for(const r of e)for(const s of M){const t=Object.keys(r.data).find(l=>l.trim().toLowerCase()===s);if(!t)continue;const o=r.data[t]?.trim();o&&n[s].add(o)}return[n.color,n.make,n.model].map(r=>r.size?[...r].join("/"):"").filter(Boolean).join(" ")}const T=["XYZ999","Q0Q-8B8","ABC I23","AB0-123","ABC123","E0CKICF"];function D(){return h.size?Array.from(h.keys()).reverse():[...T].reverse()}function k(){if(!h.size)return;const e={savedAt:Date.now(),loadedAt:w,entries:[...h.entries()]};localStorage.setItem(E,JSON.stringify(e))}function F(){const e=localStorage.getItem(E);if(e)try{const{savedAt:n,loadedAt:r,entries:s}=JSON.parse(e);if((Date.now()-n)/36e5>$){localStorage.removeItem(E);return}h=new Map(s),w=r,document.getElementById("loadStatus").textContent=`Loaded ${h.size} unique plates, entered at ${A(w)}`}catch{localStorage.removeItem(E)}}function N(e){const n=new Map;return e.split(/\r?\n/).map(r=>r.trim()).filter(Boolean).forEach((r,s)=>{const t=x(r);t&&(n.has(t)||n.set(t,{plate:r,rows:[]}),n.get(t).rows.push({line:s+1,data:{Raw:r}}))}),n}function U(e){const n=e.trim().split(/\r?\n/),r=n[0].split(/\t/).map(l=>l.trim()),s=n.slice(1);let t=r.findIndex(l=>/plate|tag|number/i.test(l));t<0&&(t=0);const o=new Map;return s.forEach((l,S)=>{const p=l.split(/\t/),y=p[t];if(!y)return;const u=x(y);if(!u)return;o.has(u)||o.set(u,{plate:y,rows:[]});const a={};r.forEach((i,c)=>a[i]=p[c]?.trim()||""),o.get(u).rows.push({line:S+2,data:a})}),o}function b(){const n=plateInput.value.split(/\r?\n/).map(s=>s.trim()).filter(s=>s!=="").join(`
`);if(plateInput.value=n,!n)return;h=n.includes("	")?U(n):N(n),w=Date.now(),k(),loadStatus.textContent=`Loaded ${h.size} unique plates, entered at ${A(w)}`,C()}clearStoredPlates.addEventListener("click",()=>{localStorage.removeItem(E),h.clear(),plateInput.value="",loadStatus.textContent="Cleared saved plates",w=null,C()});function C(){let e=!1;const n=searchInput.value,r=results;if(r.innerHTML="",D().forEach(s=>{const t=O(s,n);if(!t.match)return;e=!0;const o=document.createElement("li"),l=h.get(s);if(!l){o.innerHTML=`<div style="font-family:monospace;font-size:1.4rem;font-weight:bold">${t.rendered}</div>`,r.appendChild(o);return}const S=document.createElement("details"),p=document.createElement("summary");p.innerHTML=t.rendered;const y=B(l.rows);if(y){const u=document.createElement("div");u.className="sum-line",u.textContent=y,p.appendChild(u)}S.appendChild(p),l.rows.forEach(u=>{const a=document.createElement("div");a.className="details-meta";const i=Object.entries(u.data).filter(([c,m])=>m&&m.trim()).map(([c,m])=>`${c}=${m}`).join(" | ");a.textContent=`Line ${u.line}: ${i}`,S.appendChild(a)}),o.appendChild(S),r.appendChild(o)}),!e&&n.trim()!==""){const s=document.createElement("li");s.textContent="No matching results",s.style.color="#888",s.style.fontSize="1rem",s.style.padding="8px 0 0 0",r.appendChild(s)}}loadBtn.addEventListener("click",b);searchInput.addEventListener("input",C);F();C();</script>
    <style rel="stylesheet" crossorigin>:root{--bg: #fff;--text: #111;--exact-color: lightgreen;--fuzzy-color: #ffea70}body{background:var(--bg);color:var(--text);font-family:sans-serif;padding:12px;max-width:640px;margin:auto}#searchBar{position:sticky;top:0;background:color-mix(in srgb,var(--bg) 80%,transparent);padding-bottom:10px;padding-top:4px;z-index:1000;border-bottom:1px solid #eee}label{line-height:2em}#searchInput{text-transform:uppercase}#searchInput::placeholder{text-transform:none}input,textarea{width:100%;font-size:1.2rem;padding:.5em;box-sizing:border-box}textarea{height:160px;font-size:1rem}button{display:block;width:100%;font-size:1.1rem;margin:6px 0;padding:10px}hr{margin-top:2em;margin-bottom:2em;border:none;height:1px;background-color:#ddd}ul#results{list-style:none;padding:0}summary{cursor:pointer;padding:6px 4px;font-weight:700;font-family:monospace;font-size:1.3rem}.sum-line{font-size:.9rem;color:gray}.details-meta{font-size:.8rem;padding-left:4px;margin-bottom:6px}.exact-match{background:var(--exact-color);color:#000}.fuzzy-match{background:var(--fuzzy-color);color:#000}</style>
  </head>
  <body>

    <header id="searchBar">
      <label for="searchInput">Search partial plates:</label>
      <input id="searchInput"
             type="search"
             placeholder="Type to search..."
             autocomplete="off"
	     autocapitalize="off"
	     spellcheck="false"
             enterkeyhint="done"
             autofocus />
    </header>

    <ul id="results"></ul>

    <hr/>

    <label for="plateInput">Plate list (plain or TSV):</label>
    <textarea id="plateInput" spellcheck="false" placeholder="Copy plates from spreadsheet here. Columns containing 'plate', 'make', 'model', or 'color' will be recognized."></textarea>
    <button id="loadBtn">Load Plates</button>
    <button id="clearStoredPlates">Clear saved plates</button>
    <div id="loadStatus"></div>

    <!-- <pre id="testOutput"></pre> -->
    <!-- <script type="module" src="tests.js"></script> -->
  </body>
</html>
