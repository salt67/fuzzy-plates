<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fuzzy Plate Search</title>
    <link rel="apple-touch-icon" href="./image-EX1McLRR.png">
    <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=o(n);fetch(n.href,s)}})();const P=[["D","O"],["M","W"],["P","R"],["7","Z"],["0","D"],["5","S"],["V","W"],["2","Z"],["1","I"],["I","T"],["X","Y"],["7","T"],["0","Q"],["1","L"],["4","L"],["E","F"],["8","B"],["D","Q"],["0","O"],["O","Q"],["0","U"]],w=new Map;for(const[t,e]of P){const o=t.toUpperCase(),r=e.toUpperCase();w.has(o)||w.set(o,new Set),w.has(r)||w.set(r,new Set),w.get(o).add(r),w.get(r).add(o)}function x(t,e){return w.has(t)&&w.get(t).has(e)}function I(t){return t.replace(/[-\s]/g,"").toUpperCase()}function $(t,e){const o=I(e);if(!o)return{match:!0,rendered:t,meta:Array(t.length).fill("")};const r=t.toUpperCase().split("");if(o.length===1){const a=o[0],l=Array(t.length).fill("");let u=!1;for(let m=0;m<r.length;m++){const p=r[m];if(!/[A-Z0-9]/.test(p)){l[m]="-";continue}p===a?(l[m]="E",u=!0):x(p,a)&&(l[m]="F",u=!0)}if(!u)return{match:!1,rendered:null,meta:[]};let h="";for(let m=0;m<t.length;m++){const p=t[m],z=l[m];z==="E"?h+=`<span class="exact-match">${p}</span>`:z==="F"?h+=`<span class="fuzzy-match">${p}</span>`:h+=p}return{match:!0,rendered:h,meta:l}}const n=I(t),s=o.split(""),i=[];for(let a=0;a<=n.length-s.length;a++){let l=!0;const u=Array(n.length).fill(null);let h=0,m=0;for(let p=0;p<s.length;p++){const z=n[a+p],L=s[p];if(z===L)u[a+p]="E",h++;else if(x(z,L))u[a+p]="F",m++;else{l=!1;break}}l&&i.push({start:a,marks:u,exact:h,fuzzy:m})}if(!i.length)return{match:!1,rendered:null,meta:[]};i.sort((a,l)=>l.exact!==a.exact?l.exact-a.exact:a.fuzzy!==l.fuzzy?a.fuzzy-l.fuzzy:a.start-l.start);const d=i[0],f=Array(t.length).fill("");let g=0;for(let a=0;a<t.length;a++){const l=r[a];if(!/[A-Z0-9]/.test(l)){f[a]="-";continue}const u=d.marks[g];u&&(f[a]=u),g++}let c="";for(let a=0;a<t.length;a++){const l=t[a],u=f[a];u==="E"?c+=`<span class="exact-match">${l}</span>`:u==="F"?c+=`<span class="fuzzy-match">${l}</span>`:c+=l}return{match:!0,rendered:c,meta:f}}const E="fuzzyPlateData",O=12,M=["color","make","model"];let C=null,y=new Map;function v(t){return t?new Date(t).toLocaleString():""}function A(t){return t.replace(/[^A-Za-z0-9]/g,"").toUpperCase()}function j(t){const e={color:new Set,make:new Set,model:new Set};function o(n){return n.toLowerCase().replace(/\b\w/g,s=>s.toUpperCase())}for(const n of t)for(const s of M){const i=Object.keys(n.data).find(c=>c.trim().toLowerCase()===s);if(!i)continue;const f=(n.data[i]??"").trim();if(!f)continue;const g=o(f);e[s].add(g)}const r=[];return e.color.size>0&&r.push([...e.color].join("/")),e.make.size>0&&r.push([...e.make].join("/")),e.model.size>0&&r.push([...e.model].join("/")),r.join(" ")}function b(t){const e=t.map((i,d)=>({h:i,i:d})).filter(({h:i})=>/plate/i.test(i));if(e.length===0)return{index:0,name:t[0]||"(first column)"};if(e.length===1)return{index:e[0].i,name:e[0].h};const o=e.map((i,d)=>`${d+1}. ${i.h}`).join(`
`),r=window.prompt(`Multiple plate columns found. Which one should be used?

${o}

Enter 1-${e.length}:`,"1");if(r===null)return{index:-1,name:null};const n=parseInt(r,10);if(!Number.isInteger(n)||n<1||n>e.length)return{index:-1,name:null};const s=e[n-1];return{index:s.i,name:s.h}}const k=["XYZ999","Q0Q-8B8","ABC I23","AB0-123","ABC123","E0CKICF"];function B(){return y.size?Array.from(y.keys()).reverse():[...k].reverse()}function D(){if(!y.size)return;const t={savedAt:Date.now(),loadedAt:C,entries:[...y.entries()]};localStorage.setItem(E,JSON.stringify(t))}function N(){const t=localStorage.getItem(E);if(t)try{const{savedAt:e,loadedAt:o,entries:r}=JSON.parse(t);if((Date.now()-e)/36e5>O){localStorage.removeItem(E);return}y=new Map(r),C=o,document.getElementById("loadStatus").textContent=`Loaded ${y.size} unique plates, entered at ${v(C)}`}catch{localStorage.removeItem(E)}}function U(t){const e=new Map;return t.split(/\r?\n/).map(o=>o.trim()).filter(Boolean).forEach((o,r)=>{const n=A(o);n&&(e.has(n)||e.set(n,{plate:o,rows:[]}),e.get(n).rows.push({line:r+1,data:{Raw:o}}))}),e}function F(t,e=0){const o=t.trim().split(/\r?\n/),r=o[0].split(/\t/).map(i=>i.trim()),n=o.slice(1),s=new Map;return n.forEach((i,d)=>{const f=i.split(/\t/),g=f[e];if(!g)return;const c=A(g);if(!c)return;s.has(c)||s.set(c,{plate:g,rows:[]});const a={};r.forEach((l,u)=>a[l]=f[u]?.trim()||""),s.get(c).rows.push({line:d+2,data:a})}),s}function T(){const e=plateInput.value.split(/\r?\n/).map(r=>r.trim()).filter(r=>r!=="").join(`
`);if(plateInput.value=e,!e)return;let o;if(e.includes("	")){const n=e.split(/\r?\n/)[0].split(/\t/).map(d=>d.trim()),{index:s,name:i}=b(n);if(s<0){loadStatus.textContent="Import cancelled.";return}o=F(e,s)}else o=U(e);y=o,C=Date.now(),D(),loadStatus.textContent=`Loaded ${y.size} unique plates, entered at ${v(C)}`,S()}clearStoredPlates.addEventListener("click",()=>{localStorage.removeItem(E),y.clear(),plateInput.value="",loadStatus.textContent="Cleared saved plates",C=null,S()});function S(){let t=!1;const e=searchInput.value,o=results;if(o.innerHTML="",B().forEach(r=>{const n=$(r,e);if(!n.match)return;t=!0;const s=document.createElement("li"),i=y.get(r);if(!i){s.innerHTML=`<div style="font-family:monospace;font-size:1.4rem;font-weight:bold">${n.rendered}</div>`,o.appendChild(s);return}const d=document.createElement("details"),f=document.createElement("summary");f.innerHTML=n.rendered;const g=j(i.rows);if(g){const c=document.createElement("div");c.className="sum-line",c.textContent=g,f.appendChild(c)}d.appendChild(f),i.rows.forEach(c=>{const a=document.createElement("div");a.className="details-meta";const l=Object.entries(c.data).filter(([u,h])=>h&&h.trim()).map(([u,h])=>`${u}=${h}`).join(" | ");a.textContent=`Line ${c.line}: ${l}`,d.appendChild(a)}),s.appendChild(d),o.appendChild(s)}),!t&&e.trim()!==""){const r=document.createElement("li");r.textContent="No matching results",r.style.color="#888",r.style.fontSize="1rem",r.style.padding="8px 0 0 0",o.appendChild(r)}}loadBtn.addEventListener("click",T);searchInput.addEventListener("input",S);N();S();</script>
    <style rel="stylesheet" crossorigin>:root{--bg: #fff;--text: #111;--exact-color: lightgreen;--fuzzy-color: #ffea70}body{background:var(--bg);color:var(--text);font-family:sans-serif;padding:12px;max-width:640px;margin:auto}#searchBar{position:sticky;top:0;background:color-mix(in srgb,var(--bg) 80%,transparent);padding-bottom:10px;padding-top:4px;z-index:1000;border-bottom:1px solid #eee}label{line-height:2em}#searchInput{text-transform:uppercase}#searchInput::placeholder{text-transform:none}input,textarea{width:100%;font-size:1.2rem;padding:.5em;box-sizing:border-box}textarea{height:160px;font-size:1rem}button{display:block;width:100%;font-size:1.1rem;margin:6px 0;padding:10px}hr{margin-top:2em;margin-bottom:2em;border:none;height:1px;background-color:#ddd}ul#results{list-style:none;padding:0}summary{cursor:pointer;padding:6px 4px;font-weight:700;font-family:monospace;font-size:1.3rem}.sum-line{font-size:.9rem;color:gray}.details-meta{font-size:.8rem;padding-left:4px;margin-bottom:6px}.exact-match{background:var(--exact-color);color:#000}.fuzzy-match{background:var(--fuzzy-color);color:#000}#loadStatus{margin-bottom:1em}</style>
  </head>
  <body>

    <header id="searchBar">
      <label for="searchInput">Search partial plates:</label>
      <input id="searchInput"
             type="search"
             placeholder="Type to search..."
             autocomplete="off"
	     autocapitalize="off"
	     spellcheck="false"
             enterkeyhint="done"
             autofocus />
    </header>

    <ul id="results"></ul>

    <hr/>

    <label for="plateInput">Plate list (plain or TSV):</label>
    <textarea id="plateInput" spellcheck="false" placeholder="Copy plates from spreadsheet here. Columns containing 'plate', 'make', 'model', or 'color' will be recognized."></textarea>
    <button id="loadBtn">Load Plates</button>
    <button id="clearStoredPlates">Clear saved plates</button>
    <div id="loadStatus"></div>

    <!-- <pre id="testOutput"></pre> -->
    <!-- <script type="module" src="tests.js"></script> -->
    <footer>
      Nothing you type or paste is sent anywhere, it stays only on your device. <a href="https://github.com/salt67/fuzzy-plates">More info and source code here.</a>
    </footer>
  </body>
</html>
